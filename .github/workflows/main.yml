name: Windows MSVC (Qt5 Static One-EXE)

on:
  push:
    branches: [ "master" ]
    tags: [ "v*", "V*", "release-*"]
  pull_request:
    branches: [ "master" ]

jobs:
  qt-static-build:
    name: Build & Cache Qt 5.15.2 Static (MSVC)
    runs-on: windows-latest
    env:
      QT_VER: "5.15.2"
      QT_TRIPLET: "msvc2019_64"
      QT_SRC_ROOT: "C:\\qt-src\\5.15.2\\Src"
      QT_INSTALL_PREFIX: "C:\\qt-static\\5.15.2\\msvc2019_64-static"

    steps:
      - name: Setup MSVC (VS 2022, x64)
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Restore Qt static cache
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: "${{ env.QT_INSTALL_PREFIX }}"
          key: "qt5static-${{ env.QT_VER }}-${{ env.QT_TRIPLET }}-msvc2022-opengl-desktop-staticruntime-v1"

      - name: Install Python (for aqt)
        if: steps.cache-qt.outputs.cache-hit != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Perl (required by Qt build on Windows)
        if: steps.cache-qt.outputs.cache-hit != 'true'
        uses: shogo82148/actions-setup-perl@v1
        with:
          perl-version: "5.32"

      - name: Install aqt
        run: |
          pip install "aqtinstall==3.1.*"

      - name: Ensure Qt sources present
        run: |
          if not exist "C:\qt-src\5.15.2\Src" (
            python -m aqt install-src windows desktop 5.15.2 --outputdir "C:\qt-src"
          )

      - name: Configure + Build + Install Qt (static + /MT) if not cached
        if: steps.cache-qt.outputs.cache-hit != 'true'
        shell: cmd
        env:
          QT_INSTALL_PREFIX: "C:\\qt-static\\5.15.2\\msvc2019_64-static"
          QT_SRC_ROOT: "C:\\qt-src\\5.15.2\\Src"
        run: |
          cd /d %QT_SRC_ROOT%\qtbase
          call configure.bat -prefix "%QT_INSTALL_PREFIX%" -platform win32-msvc ^
            -release -static -static-runtime -opensource -confirm-license ^
            -opengl desktop -nomake tests -nomake examples ^
            -no-icu -no-dbus -no-angle -mp
          nmake /NOLOGO
          nmake /NOLOGO install

      # Garante módulos SEMPRE: recompila/instala se faltar lib OU .pri
      - name: Ensure Qt modules (SVG, Multimedia, SerialPort) - out-of-source + features
        shell: cmd
        env:
          QT_INSTALL_PREFIX: "C:\\qt-static\\5.15.2\\msvc2019_64-static"
          QT_SRC_ROOT: "C:\\qt-src\\5.15.2\\Src"
        run: |
          set QTDIR=%QT_INSTALL_PREFIX%
          set PATH=%QTDIR%\bin;%PATH%

          set MOD_BUILD=C:\qt-build-mods
          if not exist "%MOD_BUILD%" mkdir "%MOD_BUILD%"

          goto after_functions
          :ensure_module
          rem %1 = modulo (ex.: qtmultimedia)
          rem %2 = lib base (ex.: Qt5Multimedia)
          rem %3 = pri base (ex.: qt_lib_multimedia)
          set MOD=%1
          set LIBBASE=%2
          set PRIBASE=%3
          set MOD_SRC=%QT_SRC_ROOT%\%MOD%
          set MOD_BLD=%MOD_BUILD%\%MOD%

          set NEED=0
          if not exist "%QTDIR%\lib\%LIBBASE%.lib" set NEED=1
          if not exist "%QTDIR%\mkspecs\modules\%PRIBASE%.pri" set NEED=1

          if "%NEED%"=="0" (
            echo %LIBBASE% / %PRIBASE%.pri ja presentes — pulando %MOD%.
            goto :eof
          )

          echo === Construindo %MOD% (faltava lib ou pri) ===
          if not exist "%MOD_BLD%" mkdir "%MOD_BLD%"
          cd /d "%MOD_BLD%"
          set QMAKEFEATURES=%MOD_SRC%\mkspecs\features
          "%QTDIR%\bin\qmake" "%MOD_SRC%\src\src.pro" -r
          nmake /NOLOGO
          nmake /NOLOGO install
          echo === %MOD% instalado. ===
          goto :eof
          :after_functions

          call :ensure_module qtsvg Qt5Svg qt_lib_svg
          call :ensure_module qtmultimedia Qt5Multimedia qt_lib_multimedia
          call :ensure_module qtserialport Qt5SerialPort qt_lib_serialport

          echo ----- Present Qt libs -----
          dir /b "%QTDIR%\lib\Qt5*.lib"
          echo ----- Present Qt module PRIs -----
          dir /b "%QTDIR%\mkspecs\modules\qt_lib_*.pri"

  build-app:
    name: Build App (Static, One EXE)
    needs: qt-static-build
    runs-on: windows-latest
    env:
      PRO_DIR: "build_XX"
      PRO_FILE: "SimulIDE_Build.pro"
      BUILD_DIR: "out_msvc"
      CONFIG: "release"
      QT_INSTALL_PREFIX: "C:\\qt-static\\5.15.2\\msvc2019_64-static"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup MSVC (VS 2022, x64)
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Restore Qt static cache
        uses: actions/cache@v4
        with:
          path: "${{ env.QT_INSTALL_PREFIX }}"
          key: "qt5static-5.15.2-msvc2019_64-msvc2022-opengl-desktop-staticruntime-v1"

      - name: Prepare build directory (out-of-source)
        shell: pwsh
        run: |
          if (-not (Test-Path $env:BUILD_DIR)) { New-Item -ItemType Directory -Path $env:BUILD_DIR | Out-Null }

      # (Opcional, mas útil) Debug: conferir se multimedia está realmente instalado
      - name: Debug installed Qt modules
        shell: pwsh
        run: |
          Write-Host "Libraries in $env:QT_INSTALL_PREFIX\lib:"
          Get-ChildItem "$env:QT_INSTALL_PREFIX\lib" -Filter "Qt5*.lib" | Sort-Object Name | Select-Object -ExpandProperty Name
          Write-Host "`nModule PRIs in $env:QT_INSTALL_PREFIX\mkspecs\modules:"
          Get-ChildItem "$env:QT_INSTALL_PREFIX\mkspecs\modules" -Filter "qt_lib_*.pri" | Sort-Object Name | Select-Object -ExpandProperty Name

      # Reforço CRT estático antes do qmake
      - name: Force static CRT (/MT) in .pro
        shell: pwsh
        run: |
          $proPath = Join-Path $env:PRO_DIR $env:PRO_FILE
          if (-not (Test-Path $proPath)) { Write-Host "Aviso: $proPath não encontrado. Pulando reforço de /MT."; exit 0 }
          Add-Content $proPath "QMAKE_CFLAGS_RELEASE += /MT`n"
          Add-Content $proPath "QMAKE_CXXFLAGS_RELEASE += /MT`n"
          Add-Content $proPath "QMAKE_LFLAGS_RELEASE += /NODEFAULTLIB:MSVCRT`n"

      - name: qmake (Static Release) using build_XX/SimulIDE_Build.pro
        shell: cmd
        env:
          QT_INSTALL_PREFIX: "C:\\qt-static\\5.15.2\\msvc2019_64-static"
        run: |
          set QTDIR=%QT_INSTALL_PREFIX%
          set PATH=%QTDIR%\bin;%PATH%
          cd %BUILD_DIR%
          qmake "%GITHUB_WORKSPACE%\%PRO_DIR%\%PRO_FILE%" -r -spec win32-msvc "CONFIG+=release static"

      - name: Build with nmake
        shell: cmd
        env:
          QT_INSTALL_PREFIX: "C:\\qt-static\\5.15.2\\msvc2019_64-static"
        run: |
          set QTDIR=%QT_INSTALL_PREFIX%
          set PATH=%QTDIR%\bin;%PATH%
          cd %BUILD_DIR%
          nmake /NOLOGO

      - name: Locate EXE (single-file)
        id: out
        shell: pwsh
        run: |
          $exe = Get-ChildItem ".\${env:BUILD_DIR}" -Recurse -Filter *.exe -ErrorAction SilentlyContinue |
                 Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $exe) {
            $exe = Get-ChildItem "$env:GITHUB_WORKSPACE" -Recurse -Filter *.exe -ErrorAction SilentlyContinue |
                   Sort-Object LastWriteTime -Descending | Select-Object -First 1
          }
          if (-not $exe) { throw "Nenhum .exe encontrado após o build." }
          "EXE=$($exe.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Host "EXE encontrado: $($exe.FullName)"

      - name: Compute vars (short sha)
        id: vars
        shell: pwsh
        run: |
          $short = $env:GITHUB_SHA.Substring(0,7)
          "short_sha=$short" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Make ZIP artifact
        id: pack
        shell: pwsh
        run: |
          $zip = "SimulIDE-MSVC-STATIC-${{ steps.vars.outputs.short_sha }}.zip"
          Compress-Archive -Path "${{ steps.out.outputs.EXE }}" -DestinationPath "$zip" -Force
          "ZIP=$zip" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Host "ZIP criado: $zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: SimulIDE-MSVC-STATIC
          path: "${{ steps.pack.outputs.ZIP }}"
          if-no-files-found: error
          retention-days: 14

      - name: Create GitHub Release (on tags)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: "${{ steps.pack.outputs.ZIP }}"
          generate_release_notes: true
