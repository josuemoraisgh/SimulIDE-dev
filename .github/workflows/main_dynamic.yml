name: Build & Release (Windows MinGW, portable)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Versão/Tag (ex.: V2.0.0)"
        required: true
        type: string
      prerelease:
        description: "Marcar como pré-release?"
        required: false
        default: false
        type: boolean
      notes:
        description: "Notas da release (opcional)"
        required: false
        type: string

permissions:
  contents: write

env:
  VERSION: ${{ github.event.inputs.version }}
  ZIP_NAME: SimulIDE-${{ github.event.inputs.version }}-windows-mingw64.zip
  ZIP_REL_PATH: release/SimulIDE-${{ github.event.inputs.version }}-windows-mingw64.zip

jobs:
  build-windows-mingw:
    name: Windows (MSYS2 / MinGW64 / Qt5) – Portable
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Habilitar long paths no Git
        shell: pwsh
        run: |
          git config --system core.longpaths true
          git config --global core.longpaths true

      - name: Setup MSYS2 + MinGW64 + Qt5 (+ Tools)
        uses: msys2/setup-msys2@v2
        with:
          release: true
          update: true
          msystem: MINGW64
          path-type: minimal
          cache: true
          install: >-
            base-devel
            git
            zip
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-make
            mingw-w64-x86_64-binutils
            mingw-w64-x86_64-qt5-base
            mingw-w64-x86_64-qt5-svg
            mingw-w64-x86_64-qt5-multimedia
            mingw-w64-x86_64-qt5-serialport
            mingw-w64-x86_64-qt5-script
            mingw-w64-x86_64-qt5-tools
            mingw-w64-x86_64-qt5-translations
            mingw-w64-x86_64-ntldd-git

      - name: Preflight – estrutura esperada
        shell: bash
        run: |
          set -euo pipefail
          [ -d build_XX ] || { echo "❌ build_XX não encontrado"; exit 1; }
          echo "✔ Estrutura OK"

      - name: Restaurar SimulIDE.pri e build_XX/SimulIDE_Build.pro (UTF-8)
        shell: msys2 {0}
        run: |
          set -Eeuo pipefail
          export PATH="/mingw64/bin:$PATH"

          mkdir -p build_XX

          # --- restaura build_XX/SimulIDE_Build.pro ---
          cat > build_XX/SimulIDE_Build.pro <<'EOF'
          BUILD_DIR = $$PWD
          
          include(../SimulIDE.pri)
          EOF
          
                    # --- restaura SimulIDE.pri (conteúdo que você enviou) ---
                    cat > SimulIDE.pri <<'EOF'
          VERSION = "2.0.0"
          RELEASE = ""
          
          TEMPLATE = app
          TARGET = simulide
          
          QT += svg
          QT += xml
          QT += widgets
          QT += concurrent
          QT += serialport
          QT += multimedia widgets
          
          SOURCES      = $$files( $$PWD/src/*.cpp, true )
          HEADERS      = $$files( $$PWD/src/*.h, true )
          TRANSLATIONS = $$files( $$PWD/resources/translations/*.ts )
          FORMS       += $$files( $$PWD/src/*.ui, true )
          RESOURCES    = $$PWD/src/application.qrc
          
          INCLUDEPATH += $$PWD/src \
              $$PWD/src/components \
              $$PWD/src/components/active \
              $$PWD/src/components/connectors \
              $$PWD/src/components/graphical \
              $$PWD/src/components/logic \
              $$PWD/src/components/meters \
              $$PWD/src/components/micro \
              $$PWD/src/components/other \
              $$PWD/src/components/other/truthtable \
              $$PWD/src/components/outputs \
              $$PWD/src/components/outputs/displays \
              $$PWD/src/components/outputs/leds \
              $$PWD/src/components/outputs/motors \
              $$PWD/src/components/passive \
              $$PWD/src/components/passive/reactive \
              $$PWD/src/components/passive/resistors \
              $$PWD/src/components/passive/resist_sensors \
              $$PWD/src/components/sources \
              $$PWD/src/components/subcircuits \
              $$PWD/src/components/switches \
              $$PWD/src/gui \
              $$PWD/src/gui/appdialogs \
              $$PWD/src/gui/circuitwidget \
              $$PWD/src/gui/componentlist \
              $$PWD/src/gui/dataplotwidget \
              $$PWD/src/gui/editorwidget \
              $$PWD/src/gui/editorwidget/debuggers \
              $$PWD/src/gui/editorwidget/dialogs \
              $$PWD/src/gui/filebrowser \
              $$PWD/src/gui/memory \
              $$PWD/src/gui/properties \
              $$PWD/src/gui/serial \
              $$PWD/src/gui/testing \
              $$PWD/src/simulator \
              $$PWD/src/simulator/elements \
              $$PWD/src/simulator/elements/active \
              $$PWD/src/simulator/elements/outputs \
              $$PWD/src/simulator/elements/passive \
              $$PWD/src/microsim \
              $$PWD/src/microsim/cores \
              $$PWD/src/microsim/cores/avr \
              $$PWD/src/microsim/cores/i51 \
              $$PWD/src/microsim/cores/pic \
              $$PWD/src/microsim/cores/mcs65 \
              $$PWD/src/microsim/cores/z80 \
              $$PWD/src/microsim/cores/scripted \
              $$PWD/src/microsim/cores/qemu \
              $$PWD/src/microsim/cores/qemu/esp32 \
              $$PWD/src/microsim/cores/qemu/stm32 \
              $$PWD/src/microsim/modules \
              $$PWD/src/microsim/modules/memory \
              $$PWD/src/microsim/modules/usart \
              $$PWD/src/microsim/modules/onewire\
              $$PWD/src/microsim/modules/twi \
              $$PWD/src/microsim/modules/tcp\
              $$PWD/src/microsim/modules/spi\
              $$PWD/src/microsim/modules/script\
              $$PWD/src/angel/include \
              $$PWD/src/angel/JIT \
              $$PWD/src/angel/src
          
          QMAKE_CXXFLAGS += -Wno-unused-parameter
          QMAKE_CXXFLAGS += -Wno-deprecated-declarations
          QMAKE_CXXFLAGS += -Wno-implicit-fallthrough
          QMAKE_CXXFLAGS += -fno-strict-aliasing      #AngelScript
          QMAKE_CXXFLAGS += -Wno-cast-function-type   #AngelScript
          QMAKE_CXXFLAGS += -Wno-deprecated-copy      #AngelScript
          QMAKE_CXXFLAGS += -Wno-invalid-offsetof     #AngelScript
          QMAKE_CXXFLAGS += -Ofast
          QMAKE_CXXFLAGS_DEBUG += -D_GLIBCXX_ASSERTIONS
          QMAKE_CXXFLAGS_DEBUG -= -O
          QMAKE_CXXFLAGS_DEBUG -= -O1
          QMAKE_CXXFLAGS_DEBUG -= -O2
          QMAKE_CXXFLAGS_DEBUG -= -O3
          QMAKE_CXXFLAGS_DEBUG += -O0
          
          LIBS += -lz
          
          win32 {
              OS = Windows
              QMAKE_LIBS += -lwsock32
              RC_ICONS += $$PWD/resources/icons/simulide.ico
          }
          linux {
              OS = Linux
          }
          macx {
              OS = MacOs
              ICON = $$PWD/resources/icons/simulide.icns
          
              QMAKE_CXXFLAGS -= -stdlib=libc++
              QMAKE_LFLAGS   -= -stdlib=libc++
          
              QMAKE_CC   = /usr/local/Cellar/gcc@7/7.5.0_4/bin/gcc-7
              QMAKE_CXX  = /usr/local/Cellar/gcc@7/7.5.0_4/bin/g++-7
              QMAKE_LINK = /usr/local/Cellar/gcc@7/7.5.0_4/bin/g++-7
          }
          
          contains( QMAKE_HOST.arch, arm64|aarch64 ) | contains( QMAKE_CC, .*aarch64.* ){
              SOURCES += $$PWD/src/angel/src/as_callfunc_arm64_gcc.S
          }
          
          contains( QMAKE_HOST.os, Windows ) {
              REV_NO = $$system("powershell -Command get-date -format yy-MM-dd")
              BUILD_DATE = $$system("powershell -Command get-date -format dd-MM-yy")
          }
          else {
              REV_NO = $$system($(which date) +\"\\\"%y%m%d\\\"\")
              BUILD_DATE = $$system($(which date) +\"\\\"%d-%m-%y\\\"\")
          }
          
          CONFIG += qt
          CONFIG += warn_on
          CONFIG += no_qml_debug
          CONFIG *= c++11
          
          DEFINES += REVNO=\\\"$$REV_NO\\\"
          DEFINES += APP_VERSION=\\\"$$VERSION-$$RELEASE\\\"
          DEFINES += BUILDDATE=\\\"$$BUILD_DATE\\\"
          
          TARGET_NAME   = SimulIDE_$$VERSION-$$RELEASE
          TARGET_PREFIX = $$BUILD_DIR/executables/$$TARGET_NAME
          
          OBJECTS_DIR *= $$OUT_PWD/build/objects
          MOC_DIR     *= $$OUT_PWD/build/moc
          INCLUDEPATH += $$MOC_DIR
          
          DESTDIR = $$TARGET_PREFIX
          
          runLrelease.commands = \
              lrelease $$PWD/resources/translations/*.ts; \
              lrelease $$PWD/resources/translations/qt/*.ts; \
              $(MOVE) $$PWD/resources/translations/*.qm $$PWD/resources/qm; \
              $(MOVE) $$PWD/resources/translations/qt/*.qm $$PWD/resources/qm;
          
          QMAKE_EXTRA_TARGETS += runLrelease
          PRE_TARGETDEPS      += runLrelease
          
          message( "-----------------------------------")
          message( "    "                               )
          message( "    "$$TARGET_NAME for $$OS         )
          message( "    "                               )
          message( "    Host:      "$$QMAKE_HOST.os     )
          message( "    Date:      "$$BUILD_DATE        )
          message( "    Qt version: "$$QT_VERSION       )
          message( "    "                               )
          message( "    Destination Folder:"            )
          message( $$TARGET_PREFIX                      )
          message( "-----------------------------------")
          EOF

          # remove CRLF (garantia)
          sed -i 's/\r$//' SimulIDE.pri build_XX/SimulIDE_Build.pro

          echo "✔ Arquivos restaurados. Primeiras linhas:"
          sed -n '1,5p' SimulIDE.pri
          sed -n '1,5p' build_XX/SimulIDE_Build.pro

      - name: Detectar Qt (qmake-qt5 / windeployqt-qt5 / lrelease-qt5) + plugins
        shell: msys2 {0}
        run: |
          set -Eeuo pipefail
          export PATH="/mingw64/bin:$PATH"

          # qmake
          if [ -f "/mingw64/bin/qmake-qt5.exe" ]; then
            QMAKE="/mingw64/bin/qmake-qt5.exe"
          elif command -v qmake-qt5 >/dev/null 2>&1; then
            QMAKE="$(command -v qmake-qt5)"
          elif command -v qmake >/dev/null 2>&1; then
            QMAKE="$(command -v qmake)"
          else
            echo "❌ qmake não encontrado"
            exit 1
          fi

          # windeployqt
          if [ -f "/mingw64/bin/windeployqt-qt5.exe" ]; then
            WINDEPLOY="/mingw64/bin/windeployqt-qt5.exe"
          elif command -v windeployqt-qt5 >/dev/null 2>&1; then
            WINDEPLOY="$(command -v windeployqt-qt5)"
          elif command -v windeployqt >/dev/null 2>&1; then
            WINDEPLOY="$(command -v windeployqt)"
          else
            WINDEPLOY=""
          fi

          # lrelease (usar o -qt5.exe)
          if [ -f "/mingw64/bin/lrelease-qt5.exe" ]; then
            LRELEASE="/mingw64/bin/lrelease-qt5.exe"
          elif command -v lrelease-qt5 >/dev/null 2>&1; then
            LRELEASE="$(command -v lrelease-qt5)"
          elif command -v lrelease >/dev/null 2>&1; then
            LRELEASE="$(command -v lrelease)"
          else
            echo "❌ lrelease não encontrado"
            exit 1
          fi

          PLUG_DIR="$("$QMAKE" -query QT_INSTALL_PLUGINS || true)"
          if [ -z "$PLUG_DIR" ] || [ ! -d "$PLUG_DIR" ]; then
            for d in /mingw64/share/qt5/plugins /mingw64/plugins /mingw64/lib/qt5/plugins; do
              [ -d "$d" ] && PLUG_DIR="$d" && break
            done
          fi

          echo "QMAKE=$QMAKE" >> $GITHUB_ENV
          echo "WINDEPLOY=$WINDEPLOY" >> $GITHUB_ENV
          echo "LRELEASE=$LRELEASE" >> $GITHUB_ENV
          echo "QT_PLUGIN_PATH=$PLUG_DIR" >> $GITHUB_ENV
          echo "/mingw64/bin" >> $GITHUB_PATH

          echo "✔ QMAKE=$QMAKE"
          echo "✔ WINDEPLOY=$WINDEPLOY"
          echo "✔ LRELEASE=$LRELEASE"
          echo "✔ QT_PLUGIN_PATH=$PLUG_DIR"

      - name: Hotfix GCC (shift de double em mcuocunit.cpp)
        shell: bash
        run: |
          set -euo pipefail
          F="src/microsim/mcuocunit.cpp"
          if [ -f "$F" ] && grep -q 'time2ovf *>> *rot' "$F"; then
            echo "Aplicando hotfix em $F"
            cp "$F" "$F.bak"
            sed -E -i 's/(addEvent\()\s*time2ovf\s*>>\s*rot(\s*,\s*this\s*\))/\1 static_cast<unsigned long long>(time2ovf) >> rot\2/' "$F"
            grep -n 'addEvent' "$F" || true
          else
            echo "Hotfix não necessário."
          fi

      - name: Compilar (qmake SimulIDE_Build.pro + mingw32-make Release)
        shell: msys2 {0}
        run: |
          set -Eeuo pipefail
          export PATH="/mingw64/bin:$PATH"
          cd build_XX

          rm -f Makefile* .qmake.stash 2>/dev/null || true
          rm -rf release build moc 2>/dev/null || true

          "$QMAKE" SimulIDE_Build.pro \
            "CONFIG+=release" \
            "QMAKE_LRELEASE=${LRELEASE}"

          CORES=$(nproc || echo 2)
          mingw32-make -j"${CORES}" release

          echo "✔ Build concluído"
          find . -maxdepth 6 -type f -name "*.exe" -print || true

      - name: Localizar executável (.exe)
        id: exe
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar nullglob nocaseglob
          mapfile -t CAND < <(ls -1t build_XX/**/simulide*.exe build_XX/**/SimulIDE*.exe 2>/dev/null || true)
          if [ ${#CAND[@]} -eq 0 ]; then
            echo "❌ Nenhum .exe encontrado em build_XX"
            find build_XX -maxdepth 6 -type f -name "*.exe" -print 2>/dev/null || true
            exit 1
          fi
          EXE="${CAND[0]}"
          EXE_DIR="$(dirname "$EXE")"
          echo "exe_unix=$EXE" >> $GITHUB_OUTPUT
          echo "exe_dir_unix=$EXE_DIR" >> $GITHUB_OUTPUT
          echo "exe_win=$(cygpath -w "$EXE")" >> $GITHUB_OUTPUT
          echo "exe_dir_win=$(cygpath -w "$EXE_DIR")" >> $GITHUB_OUTPUT

      - name: windeployqt (portable) – se disponível
        shell: msys2 {0}
        env:
          QT_PLUGIN_PATH: ${{ env.QT_PLUGIN_PATH }}
        run: |
          set -Eeuo pipefail
          export PATH="/mingw64/bin:$PATH"

          EXE_WIN="${{ steps.exe.outputs.exe_win }}"
          if [ -z "${WINDEPLOY}" ]; then
            echo "⚠️ windeployqt não encontrado — pulando."
            exit 0
          fi
          "$WINDEPLOY" --compiler-runtime "$EXE_WIN" || true

      - name: Empacotar ZIP (portable) em release/
        shell: pwsh
        run: |
          $exeDirWin  = "${{ steps.exe.outputs.exe_dir_win }}"
          $workspace  = "${{ github.workspace }}"
          $releaseDir = Join-Path $workspace "release"
          if (-not (Test-Path $releaseDir)) { New-Item -ItemType Directory -Path $releaseDir | Out-Null }
          $zipPathAbs = Join-Path $releaseDir "${{ env.ZIP_NAME }}"
          if (Test-Path $zipPathAbs) { Remove-Item $zipPathAbs -Force }
          Compress-Archive -Path (Join-Path $exeDirWin '*') -DestinationPath $zipPathAbs
          if (-not (Test-Path $zipPathAbs)) { throw "ZIP não foi gerado em: $zipPathAbs" }
          Write-Host "✔ ZIP gerado: $zipPathAbs"

      - name: Publicar artefato (CI)
        uses: actions/upload-artifact@v4
        with:
          name: SimulIDE-${{ env.VERSION }}-windows-mingw64
          path: ${{ env.ZIP_REL_PATH }}
          if-no-files-found: error

      - name: Criar Release + Tag (anexando o ZIP)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: SimulIDE ${{ env.VERSION }} (Windows MinGW, portable)
          body: ${{ github.event.inputs.notes }}
          prerelease: ${{ github.event.inputs.prerelease }}
          files: ${{ env.ZIP_REL_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
