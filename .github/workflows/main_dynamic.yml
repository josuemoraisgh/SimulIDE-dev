name: Build & Release (Windows MinGW, portable)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Versão/Tag (ex.: V2.0.0)"
        required: true
        type: string
      prerelease:
        description: "Marcar como pré-release?"
        required: false
        default: false
        type: boolean
      notes:
        description: "Notas da release (opcional)"
        required: false
        type: string

permissions:
  contents: write

env:
  VERSION: ${{ github.event.inputs.version }}
  ZIP_NAME: SimulIDE-${{ github.event.inputs.version }}-windows-mingw64.zip
  ZIP_REL_PATH: release/SimulIDE-${{ github.event.inputs.version }}-windows-mingw64.zip

jobs:
  build-windows-mingw:
    name: Windows (MSYS2 / MinGW64 / Qt5) – Portable
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Habilitar long paths no Git
        shell: pwsh
        run: |
          git config --system core.longpaths true
          git config --global core.longpaths true

      - name: Setup MSYS2 + MinGW64 + Qt5
        uses: msys2/setup-msys2@v2
        with:
          release: true
          update: true
          msystem: MINGW64
          path-type: minimal
          cache: true
          install: >-
            base-devel
            git
            zip
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-make
            mingw-w64-x86_64-binutils
            mingw-w64-x86_64-qt5-base
            mingw-w64-x86_64-qt5-svg
            mingw-w64-x86_64-qt5-multimedia
            mingw-w64-x86_64-qt5-serialport
            mingw-w64-x86_64-qt5-script
            mingw-w64-x86_64-qt5-tools
            mingw-w64-x86_64-qt5-translations
            mingw-w64-x86_64-ntldd-git

      - name: Preflight – estrutura esperada
        shell: bash
        run: |
          set -euo pipefail
          [ -d build_XX ] || { echo "❌ build_XX não encontrado"; exit 1; }
          [ -f build_XX/SimulIDE_Build.pro ] || { echo "❌ build_XX/SimulIDE_Build.pro não encontrado"; exit 1; }
          [ -f SimulIDE.pri ] || { echo "❌ SimulIDE.pri não encontrado"; exit 1; }
          echo "✔ Estrutura OK"

      - name: Normalizar arquivos qmake (.pri/.pro) – BOM + CRLF
        shell: msys2 {0}
        run: |
          set -Eeuo pipefail
          export PATH="/mingw64/bin:$PATH"

          fix() {
            [ -f "$1" ] || return 0
            sed -i '1s/^\xEF\xBB\xBF//' "$1" || true
            sed -i 's/\r$//' "$1" || true
          }

          fix SimulIDE.pri
          fix build_XX/SimulIDE_Build.pro

          find . -maxdepth 2 -type f \( -name "*.pri" -o -name "*.pro" \) -print | while read f; do
            fix "$f"
          done

          echo "✔ Normalização OK"
          sed -n '1,3p' SimulIDE.pri | cat -A
          sed -n '1,3p' build_XX/SimulIDE_Build.pro | cat -A

      - name: Detectar Qt (qmake-qt5 / windeployqt-qt5 / lrelease-qt5) + plugins
        shell: msys2 {0}
        run: |
          set -Eeuo pipefail
          export PATH="/mingw64/bin:$PATH"

          echo "MSYSTEM=$MSYSTEM"
          echo "PATH=$PATH"
          echo "Bins:"
          ls -la /mingw64/bin/qmake* 2>/dev/null || true
          ls -la /mingw64/bin/lrelease* 2>/dev/null || true
          ls -la /mingw64/bin/windeployqt* 2>/dev/null || true

          # qmake
          if [ -f "/mingw64/bin/qmake.exe" ]; then
            QMAKE="/mingw64/bin/qmake.exe"
          elif [ -f "/mingw64/bin/qmake-qt5.exe" ]; then
            QMAKE="/mingw64/bin/qmake-qt5.exe"
          elif command -v qmake-qt5 >/dev/null 2>&1; then
            QMAKE="$(command -v qmake-qt5)"
          elif command -v qmake >/dev/null 2>&1; then
            QMAKE="$(command -v qmake)"
          else
            echo "❌ qmake não encontrado (nem qmake-qt5)."
            exit 1
          fi

          # windeployqt
          if [ -f "/mingw64/bin/windeployqt.exe" ]; then
            WINDEPLOY="/mingw64/bin/windeployqt.exe"
          elif [ -
