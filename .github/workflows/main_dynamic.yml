name: Build & Release (Windows MinGW, portable)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Vers√£o/Tag (ex.: V2.0.0)"
        required: true
        type: string
      prerelease:
        description: "Marcar como pr√©-release?"
        required: false
        default: false
        type: boolean
      notes:
        description: "Notas da release (opcional)"
        required: false
        type: string

permissions:
  contents: write

env:
  VERSION: ${{ github.event.inputs.version }}
  ZIP_NAME: SimulIDE-${{ github.event.inputs.version }}-windows-mingw64.zip
  ZIP_REL_PATH: release/SimulIDE-${{ github.event.inputs.version }}-windows-mingw64.zip

jobs:
  build-windows-mingw:
    name: Windows (MSYS2 / MinGW64 / Qt5) ‚Äì Portable
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Habilitar long paths no Git
        shell: pwsh
        run: |
          git config --system core.longpaths true
          git config --global core.longpaths true

      - name: Setup MSYS2 + MinGW64 + Qt5
        uses: msys2/setup-msys2@v2
        with:
          release: true
          update: true
          msystem: MINGW64
          path-type: minimal
          cache: true
          install: >-
            base-devel
            git
            zip
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-make
            mingw-w64-x86_64-binutils
            mingw-w64-x86_64-qt5-base
            mingw-w64-x86_64-qt5-svg
            mingw-w64-x86_64-qt5-multimedia
            mingw-w64-x86_64-qt5-serialport
            mingw-w64-x86_64-qt5-script
            mingw-w64-x86_64-qt5-tools
            mingw-w64-x86_64-qt5-translations
            mingw-w64-x86_64-ntldd-git

      - name: Preflight ‚Äì estrutura esperada
        shell: bash
        run: |
          set -euo pipefail
          [ -d build_XX ] || { echo "‚ùå build_XX n√£o encontrado"; exit 1; }
          [ -f build_XX/SimulIDE_Build.pro ] || { echo "‚ùå SimulIDE_Build.pro n√£o encontrado"; exit 1; }
          [ -f SimulIDE.pri ] || { echo "‚ùå SimulIDE.pri n√£o encontrado"; exit 1; }
          echo "‚úî Estrutura OK"

      - name: Normalizar arquivos qmake (.pri/.pro) ‚Äì BOM + CRLF
        shell: msys2 {0}
        run: |
          set -euo pipefail

          fix() {
            sed -i '1s/^\xEF\xBB\xBF//' "$1" || true
            sed -i 's/\r$//' "$1" || true
          }

          fix SimulIDE.pri
          fix build_XX/SimulIDE_Build.pro

          find . -maxdepth 2 -type f \( -name "*.pri" -o -name "*.pro" \) -print | while read f; do
            fix "$f"
          done

          echo "‚úî Arquivos normalizados"

      - name: Detectar Qt + localizar lrelease.exe (robusto)
        shell: msys2 {0}
        run: |
          set -Eeuxo pipefail
          trap 'echo "‚ùå Falhou no step: $GITHUB_STEP_SUMMARY"; echo "‚ùå Linha: $LINENO"; echo "‚ùå Comando: $BASH_COMMAND"; env | sort | sed -n "1,120p"' ERR

          export PATH="/mingw64/bin:$PATH"

          QMAKE="$(command -v qmake)"
          WINDEPLOY="$(command -v windeployqt || true)"

          if [ -z "$QMAKE" ]; then
            echo "‚ùå qmake n√£o encontrado"
            exit 1
          fi

          # localizar lrelease.exe (mesmo fora do PATH)
          if command -v lrelease >/dev/null 2>&1; then
            LRELEASE="$(command -v lrelease)"
          elif [ -f /mingw64/bin/lrelease.exe ]; then
            LRELEASE="/mingw64/bin/lrelease.exe"
          else
            echo "üîé lrelease n√£o encontrado, tentando localizar via pacman -F"
            pacman -Fy --noconfirm
            PKG="$(pacman -Fq mingw64/bin/lrelease.exe | head -n 1 || true)"
            if [ -n "$PKG" ]; then
              pacman -S --needed --noconfirm "$PKG"
            fi
            [ -f /mingw64/bin/lrelease.exe ] || { echo "‚ùå lrelease.exe n√£o encontrado"; exit 1; }
            LRELEASE="/mingw64/bin/lrelease.exe"
          fi

          echo "QMAKE=$QMAKE" >> $GITHUB_ENV
          echo "WINDEPLOY=$WINDEPLOY" >> $GITHUB_ENV
          echo "LRELEASE=$LRELEASE" >> $GITHUB_ENV
          echo "/mingw64/bin" >> $GITHUB_PATH

          echo "‚úî qmake: $QMAKE"
          echo "‚úî lrelease: $LRELEASE"

      - name: Debug geral (paths e ferramentas)
        shell: msys2 {0}
        run: |
          set -Eeuxo pipefail
          trap 'echo "‚ùå Linha: $LINENO"; echo "‚ùå Comando: $BASH_COMMAND"' ERR
          export PATH="/mingw64/bin:$PATH"
          echo "PWD=$(pwd)"
          echo "PATH=$PATH"
          uname -a || true
          which qmake || true
          which mingw32-make || true
          which g++ || true
          pacman -Q | grep -E 'mingw-w64-x86_64-qt5|mingw-w64-x86_64-gcc|mingw-w64-x86_64-make' || true
          ls -la
          ls -la build_XX
          sed -n '1,5p' SimulIDE.pri | cat -A
          sed -n '1,5p' build_XX/SimulIDE_Build.pro | cat -A


      - name: Compilar (qmake + mingw32-make Release)
        shell: msys2 {0}
        run: |
          set -euo pipefail
          export PATH="/mingw64/bin:$PATH"

          cd build_XX

          rm -f Makefile* .qmake.stash
          rm -rf release build moc

          "$QMAKE" SimulIDE_Build.pro \
            "CONFIG+=release" \
            "QMAKE_LRELEASE=${LRELEASE}"

          CORES=$(nproc || echo 2)
          mingw32-make -j"${CORES}" release

          echo "‚úî Build conclu√≠do"
          find . -name "*.exe" -print

      - name: Empacotar ZIP (portable)
        shell: pwsh
        run: |
          $exe = Get-ChildItem build_XX -Recurse -Filter *.exe | Select-Object -First 1
          if (-not $exe) { throw "‚ùå Nenhum .exe encontrado" }

          $release = Join-Path $env:GITHUB_WORKSPACE "release"
          New-Item -ItemType Directory -Force -Path $release | Out-Null

          $zip = Join-Path $release "${{ env.ZIP_NAME }}"
          if (Test-Path $zip) { Remove-Item $zip -Force }

          Compress-Archive -Path $exe.Directory.FullName\* -DestinationPath $zip
          Write-Host "‚úî ZIP criado em $zip"

      - name: Upload artefato
        uses: actions/upload-artifact@v4
        with:
          name: SimulIDE-${{ env.VERSION }}-windows-mingw64
          path: ${{ env.ZIP_REL_PATH }}

      - name: Criar Release no GitHub
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: SimulIDE ${{ env.VERSION }} (Windows portable)
          body: ${{ github.event.inputs.notes }}
          prerelease: ${{ github.event.inputs.prerelease }}
          files: ${{ env.ZIP_REL_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
